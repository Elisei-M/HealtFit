<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>HealthFit - Workouts</title>
  <link rel="stylesheet" href="style.css">
  <!-- jQuery (pentru hoverIntent) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- hoverIntent (dacă vrei) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.hoverintent/1.10.1/jquery.hoverIntent.min.js"></script>
  <!-- Snap.svg pentru încărcarea SVG -->
  <script src="https://cdn.jsdelivr.net/npm/snapsvg@0.5.1/dist/snap.svg-min.js"></script>
</head>
<body>

  <!-- Navbar -->
  <header>
    <nav>
      <ul class="navbar">
        <li><a href="index.html">Home</a></li>
        <li><a href="profile.html">Profil</a></li>
        <li><a href="nutritie.html">Nutriție</a></li>
        <li><button id="logoutBtn">Logout</button></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <div class="form">
      <h3 class="title">Program de Antrenamente Recomandat</h3>
      <p id="programText" style="color:#fff;"></p>
    </div>
  </div>

  <!-- SVG cu grupele musculare -->
  <div class="content">
    <div class="svg-container">
      <div class="card">
        <figure class="front">
          <svg id="frontSvg"></svg>
        </figure>
        <figure class="back">
          <svg id="backSvg"></svg>
        </figure>
      </div>
      <div class="labelBox">
        <span class="name"></span>
        <span class="description"></span>
      </div>
    </div>
    <a href="#" class="btn btn-primary btn-lg rotateBtn">View Back</a>
  </div>

  <!-- Afișare status recuperare mușchi -->
  <div class="container">
    <div class="form">
      <h3 class="title">Status Recuperare Grupe Musculare</h3>
      <ul id="muscleRecoveryList" style="color:#fff; list-style:none; padding:0;"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // 1. Configurație Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDkACBZ_7DJOSuko8hIHoBCGrz3EllW-GY",
      authDomain: "healthfit-9de3f.firebaseapp.com",
      projectId: "healthfit-9de3f",
      storageBucket: "healthfit-9de3f.appspot.com",
      messagingSenderId: "1071597823999",
      appId: "1:1071597823999:web:a679009ca5178340f9e9ca"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elemente HTML
    const programText = document.getElementById("programText");
    const muscleRecoveryList = document.getElementById("muscleRecoveryList");
    const logoutBtn = document.getElementById("logoutBtn");

    let currentUser = null;
    let userGoal = null;

    // 2. Verificare user
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        // Afișăm programul recomandat
        await loadUserGoal();
        displayRecommendedProgram();
        // Afișăm status recuperare
        await displayMuscleRecovery();
      }
    });

    // 3. Citim obiectivul userului
    async function loadUserGoal() {
      const userDocRef = doc(db, "users", currentUser.uid);
      const userDocSnap = await getDoc(userDocRef);
      if (userDocSnap.exists()) {
        const data = userDocSnap.data();
        userGoal = data.goal || "slabire"; // default
      } else {
        userGoal = "slabire";
      }
    }

    // 4. Afișăm un program minimal în funcție de userGoal
    function displayRecommendedProgram() {
      let text = "";
      switch (userGoal) {
        case "slabire":
          text = `
            <strong>Antrenament 1 (Piept & Triceps)</strong><br/>
            Antrenament 2 (Spate & Biceps)<br/>
            Antrenament 3 (Picioare & Umeri)<br/>
            <br/>
            3-4 sesiuni/săptămână, intensitate moderată, pauze scurte.
          `;
          break;
        case "ingrasare":
          text = `
            <strong>Antrenament 1 (Full Body)</strong><br/>
            Antrenament 2 (Full Body 2)<br/>
            <br/>
            2-3 sesiuni/săptămână, intensitate scăzută, alimentație hipercalorică.
          `;
          break;
        case "crestere_masa":
          text = `
            <strong>Antrenament 1 (Piept & Biceps)</strong><br/>
            Antrenament 2 (Spate & Triceps)<br/>
            Antrenament 3 (Picioare & Umeri)<br/>
            <br/>
            4-5 sesiuni/săptămână, intensitate moderat-ridicată, pauze 1-2 min.
          `;
          break;
        case "definire":
          text = `
            <strong>Antrenament 1 (Piept & Triceps)</strong><br/>
            Antrenament 2 (Spate & Biceps)<br/>
            Antrenament 3 (Picioare & Umeri)<br/>
            <br/>
            3-4 sesiuni/săptămână, intensitate moderată, deficit caloric ușor.
          `;
          break;
        default:
          text = `
            <strong>Antrenament 1 (Piept & Triceps)</strong><br/>
            Antrenament 2 (Spate & Biceps)<br/>
            Antrenament 3 (Picioare & Umeri)<br/>
          `;
      }
      programText.innerHTML = text;
    }

    // 5. Status recuperare musculară (simplificat)
    async function displayMuscleRecovery() {
      muscleRecoveryList.innerHTML = "";

      // Citim toate antrenamentele userului
      const workoutsRef = collection(db, "users", currentUser.uid, "workouts");
      const querySnapshot = await getDocs(workoutsRef);

      // Reținem ultima dată de antrenament pentru fiecare grupă
      const muscleLastWorkout = {
        chest: null,
        back: null,
        arms: null,
        legs: null,
        shoulders: null
        // etc.
      };

      querySnapshot.forEach((docSnap) => {
        const wData = docSnap.data();
        // Presupunem că wData conține "muscleGroup" (ex. "chest", "back", "armsFront" etc.)
        // + "date" (string "2023-05-10") sau un timestamp
        if (wData.muscleGroup) {
          const mg = wData.muscleGroup.toLowerCase();
          // Convertim data ultimului antrenament la un Date
          let workoutDate = new Date();
          if (wData.date) {
            workoutDate = new Date(wData.date);
          }
          // Dacă muscleLastWorkout[mg] e null sau e mai vechi, actualizăm
          if (!muscleLastWorkout[mg] || workoutDate > muscleLastWorkout[mg]) {
            muscleLastWorkout[mg] = workoutDate;
          }
        }
      });

      // Calculăm dacă au trecut mai mult de 48h
      const now = new Date();
      const recoveryTime = 48; // ore
      for (let mgKey in muscleLastWorkout) {
        if (muscleLastWorkout[mgKey]) {
          const diffHours = (now - muscleLastWorkout[mgKey]) / 36e5; // milisec -> ore
          const li = document.createElement("li");
          if (diffHours >= recoveryTime) {
            li.innerHTML = `<strong>${mgKey}</strong>: Recuperat (ultima dată acum ~${Math.floor(diffHours)}h)`;
          } else {
            li.innerHTML = `<strong>${mgKey}</strong>: În recuperare (antrenat acum ~${Math.floor(diffHours)}h)`;
          }
          muscleRecoveryList.appendChild(li);
        }
      }
    }

    // 6. Logout
    logoutBtn.onclick = () => {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    };

    // 7. Integrare cu Snap.svg + codul tău de manipulare a corpului
    //    (Exact codul pe care l-ai dat, adaptat într-o singură pagină)
    //    Ai nevoie să pui tot jQuery code, Snap.load, etc.

    $(document).ready(function(){
      var frontSVG = Snap("#frontSvg");
      var backSVG = Snap("#backSvg");

      var $labelBox = $('.labelBox');
      var $labelBoxName = $('.labelBox .name');
      var $labelBoxDescription = $('.labelBox .description');
      var $rotateBtn = $('.rotateBtn');

      var muscles;
      var muscleGroup;

      // 7.1 Încărcăm SVG FRONT
      Snap.load("https://s3-us-west-2.amazonaws.com/s.cdpn.io/252401/body-front.svg", function (muscleManFront) {
        frontSVG.append(muscleManFront);

        var $muscleGroups = $('#muscleChest, #muscleArmsFront, #muscleLegsFront');
        var hoverIntentConfig = {
          sensitivity: 3,
          interval: 100,
          timeout: 200,
          over: activateMuscles,
          out: deactivateMuscles
        };
        $muscleGroups.hoverIntent(hoverIntentConfig);
      });

      // 7.2 Încărcăm SVG BACK
      Snap.load("https://s3-us-west-2.amazonaws.com/s.cdpn.io/252401/body-back.svg", function (muscleManBack) {
        backSVG.append(muscleManBack);

        var $muscleGroups = $('#muscleBack, #muscleArmsBack, #muscleLegsBack');
        var hoverIntentConfig = {
          sensitivity: 3,
          interval: 100,
          timeout: 200,
          over: activateMuscles,
          out: deactivateMuscles
        };
        $muscleGroups.hoverIntent(hoverIntentConfig);
      });

      function activateMuscles(e) {
        var $this = $(this);
        // child muscle paths
        muscles = $this.children('.muscle');
        muscles.css({ fill: '#8dc63f' });

        // Simplu: setăm label
        $labelBoxName.text($this.attr('id'));
        $labelBoxDescription.text("Exerciții pentru " + $this.attr('id'));

        // Arătăm labelBox
        setTimeout(function(){
          $labelBox.addClass('visible').css({
            marginTop: '-300px',
            marginLeft: '-450px'
          });
        }, 250);
      }

      function deactivateMuscles(e) {
        var $this = $(this);
        muscles = $this.children('.muscle');
        muscles.css({ fill: '#515761' });
        $labelBox.removeClass('visible');
      }

      function rotateSVG(e) {
        e.preventDefault();
        var $card = $('.card');
        if ($card.hasClass('flipped')) {
          $card.removeClass('flipped');
          $rotateBtn.text('View Back');
        } else {
          $card.addClass('flipped');
          $rotateBtn.text('View Front');
        }
      }

      $rotateBtn.on('click', function(e){
        rotateSVG(e);
      });
    });
  </script>
</body>
</html>
